---
title: "devlog #1 - Map improvements"
date: 2024-01-02
categories: [Pet Project]
tags: [bevy, devlog, ecs, roguelike, rust]
---

Welcome to the first *official* devlog post! You can still 
[read the previous devlog entry](https://boreec.github.io/posts/devlog-0000/) to
understand the project and the idea behind. In this entry, I'll mainly share
some map improvements I've been working on.

1. [Bug Fixing: Player spawning on a non-walkable tile](#bug-fixing-player-spawning-on-a-non-walkable-tile)
2. [Bug Fixing: Pixel artifacts between the tiles](#bug-fixing-pixel-artifacts-between-tiles)
3. [Mechanics/Systems: Creating the map with cellular automaton](#mechanicssystem-creating-the-map-with-a-cellular-automaton)
4. [Closing Thoughts](#closing-thoughts)

## Bug Fixing: Player spawning on a non-walkable tile

Initially, the player was hardcoded to spawn at (0,0) regardless of the tile.
But, since the stones are randomly generated on the map, it can lead to
situations where the player spawns on a non-walkable tile.

```rust
fn spawn_player(mut commands: Commands, tileset: Res<TilesetMain>) {
    let map_position = MapPosition::new(0, 0); // hardcoded spawn :(
    let (sprite_x, sprite_y) = calculate_sprite_position(&map_position);
    commands.spawn(PlayerBundle {
        player: Player,
        position: map_position,
        sprite: SpriteSheetBundle {
            texture_atlas: tileset.0.clone(),
            transform: Transform::from_xyz(sprite_x, sprite_y, Z_INDEX_ACTOR),
            sprite: TextureAtlasSprite::new(SPRITE_IDX_PLAYER),
            ..Default::default()
        },
    });
}
```

{: style="text-align:center"}
![roguelike-6](/assets/img/blog/devlog/roguelike-0006.png)
*bug: Player spawning on a stone*

--- 

**Solution**: To fix this, the player's spawning position needs to be given by
the `Map`. It implies a the map being created before the player. To make sure
things are done in this order, I decided I split the previous
`GameState::Initializing` state in two:

```rust
#[derive(Debug, Clone, Copy, Default, Eq, PartialEq, Hash, States)]
pub enum GameState {
    #[default]
    Uninitialized,
    InitializingMap,
    InitializingPlayer,
    PlayerTurn,
    EnemyTurn,
}
```

```rust
    .add_systems(OnEnter(GameState::InitializingMap), initialize_map)
    .add_systems(OnEnter(GameState::InitializingPlayer), initialize_player)
```

When initializing the player, its spawn position is given by a method
implemented via the `Map` (now taken as a parameter):

```rust
pub fn generate_random_spawning_position(&self) -> MapPosition {
    let spawnable_positions: Vec<_> = self
        .tiles
        .iter()
        .enumerate()
        .filter(|(_, tile)| tile.is_walkable())
        .map(|(index, _)| index)
        .collect();

    if spawnable_positions.is_empty() {
        panic!("There are no spawnable positions");
    }

    let mut rng = rand::thread_rng();
    let index = *spawnable_positions.choose(&mut rng).unwrap();

    MapPosition::new(index % self.width, index / self.height)
}
```

```rust
fn initialize_player(
    mut commands: Commands,
    mut game_next_state: ResMut<NextState<GameState>>,
    query_map: Query<&Map>,
    tileset: Res<TilesetMain>,
) {
    let map = query_map.single();
    let map_position = map.generate_random_spawning_position();
    let (sprite_x, sprite_y) = calculate_sprite_position(&map_position);
    commands.spawn(PlayerBundle {
        player: Player,
        position: map_position,
        sprite: SpriteSheetBundle {
            texture_atlas: tileset.0.clone(),
            transform: Transform::from_xyz(sprite_x, sprite_y, Z_INDEX_ACTOR),
            sprite: TextureAtlasSprite::new(SPRITE_IDX_PLAYER),
            ..Default::default()
        },
    });
    game_next_state.set(GameState::PlayerTurn);
}
```

{: style="text-align:center"}
![roguelike-7](/assets/img/blog/devlog/roguelike-0007.png)
*Player spawning on a random walkable tile*

## Bug Fixing: Pixel artifacts between tiles

There's an issue I had and that have been bothering me recently. It's related
to the way tiles are displayed on screen. If you pay close attention to the
following image, you'll notice vertical pixel artifacts between the tiles.

{: style="text-align:center"}
![roguelike-8](/assets/img/blog/devlog/roguelike-0008.png)
*Pixel artifacts between the tiles*

**Solution**: It seems to be [a known issue](https://github.com/bevyengine/bevy/issues/3593) related to Bevy's [MSAA](https://docs.rs/bevy/latest/bevy/prelude/enum.Msaa.html).
After turning it off with `insert_resource(Msaa::Off)`, the pixel artifacts were gone. &#128513;

{: style="text-align:center"}
![roguelike-9](/assets/img/blog/devlog/roguelike-0009.png)
*No pixel artifacts anymore*


## Mechanics/System: Creating the map procedurally

With these issues gone, I could focus on more interesting stuff: generating the
map procedurally. Naively, one could think that putting rocks randomly on the
map is enough, but we need to take into account a couple of criteria:

1. Harmony: Using a total random placement feels heavily artificial.
It's more enjoyable to walk in a terrain that looks natural.
2. Walkable path: In its simplest form, the path from the beginning to the end
of a level must be walkable. It means that a player should never spawn trapped
between rocks. 

### Using a Cellular Automaton

### Using Perlin Noise

## Closing Thoughts

As always, if you have any suggestions/remarks regarding the devlog content, the
code or anything else, please reach out! Don't hesitate to drop a &#11088; on the [project's page](https://github.com/roguelike).
This has the immediate effect to stop me from procrastinating.
