---
title: "devlog #1 - Map creation"
date: 2024-01-02
categories: [Pet Project]
tags: [bevy, devlog, ecs, roguelike, rust]
---

[previous devlog entry](https://boreec.github.io/posts/devlog-0000/)

## Bug: Player spawning on a non-walkable tile

Initially, the player was hardcoded to spawn at (0,0) regardless of the 
environment around. Since the stones are randomly generated on the map, it can
lead to situations where the player spawns on a non-walkable tile.

```rust
fn spawn_player(mut commands: Commands, tileset: Res<TilesetMain>) {
    let map_position = MapPosition::new(0, 0);
    let (sprite_x, sprite_y) = calculate_sprite_position(&map_position);
    commands.spawn(PlayerBundle {
        player: Player,
        position: map_position,
        sprite: SpriteSheetBundle {
            texture_atlas: tileset.0.clone(),
            transform: Transform::from_xyz(sprite_x, sprite_y, Z_INDEX_ACTOR),
            sprite: TextureAtlasSprite::new(SPRITE_IDX_PLAYER),
            ..Default::default()
        },
    });
}
```

{: style="text-align:center"}
![roguelike-6](/assets/img/blog/devlog/roguelike-0006.png)
*bug: Player spawning on a stone*

**Solution**: The player needs to be created after the map and its spawning
position has to be provided by the map.

Therefore, I splitted the previous `GameState::Initializing` in two states for
creating the map and the player sequentially:
```rust
#[derive(Debug, Clone, Copy, Default, Eq, PartialEq, Hash, States)]
pub enum GameState {
    #[default]
    Uninitialized,
    InitializingMap,
    InitializingPlayer,
    PlayerTurn,
    EnemyTurn,
}
```


